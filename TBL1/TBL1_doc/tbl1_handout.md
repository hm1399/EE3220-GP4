# EE3220 TBL1 项目任务清单与详解

## 项目背景简述

你为 Space-Z 公司设计火星机器人通信的**纠错码（ECC）子系统**。深空信道会因辐射和弱信号导致比特翻转，因此需要：
- 使用 **Polar 码** 进行纠错
- 使用 **CRC-16** 进行完整性校验（嵌入在 Polar 码载荷内部）

核心安全原则：**宁可拒绝指令（valid=0），也不执行错误指令。**

---

## 任务一：设计信息位与冻结位的位置映射

### 要求
- 64 位码字中，40 位为信息位（24 位数据 + 16 位 CRC），24 位为冻结位（ECC 校验位）。
- 需要自行设计 `INFO_POS[0..39]`（信息位位置）和 `FROZEN_POS[0..23]`（冻结位位置）。
- 信息位和冻结位**不需要连续排列**。

### 设计目标
- 最大化任意两个合法 Polar 码字之间的**最小汉明距离（dmin）**。
- 本项目要求 **dmin = 8**，从而实现：
  - 纠正 1~3 位翻转
  - 检测 4 位翻转（拒绝，不会误纠）

### 解释
这是整个系统的基础。位置选择直接决定了编码的纠错能力。通常需要根据 Polar 码的信道可靠性排序（Bhattacharyya 参数或高斯近似）来选取最可靠的 40 个子信道作为信息位，其余 24 个作为冻结位。

---

## 任务二：实现 CRC-16 模块

### 要求
- 使用 **CRC-16-CCITT** 多项式：`G(x) = x^16 + x^12 + x^5 + 1`
- Verilog 中完整多项式写为 `17'h11021`，反馈异或常量为 `16'h1021`
- 初始余数：`16'h0000`
- 处理顺序：**MSB 优先**（从 `data_in[23]` 到 `data_in[0]`）
- 无反射、无最终异或

### 参考算法（比特串行）
```
crc = 0
for i = 23 downto 0:
    feedback = data_in[i] XOR crc[15]
    crc = (crc << 1) & 0xFFFF
    if feedback == 1:
        crc = crc XOR 0x1021
```

### 解释
CRC 作为额外的错误检测层嵌入在 Polar 码载荷中。编码时，对 24 位数据计算出 16 位 CRC，一起放入信息位；解码时，重新计算 CRC 并与提取出的 CRC 对比，不一致则 `valid=0`。

---

## 任务三：实现 Polar 编码器

### 模块名
`polar64_crc16_encoder`

### 接口
| 信号 | 方向 | 说明 |
|---|---|---|
| `clk` | 输入 | 时钟 |
| `rst_n` | 输入 | 低电平复位 |
| `start` | 输入 | 1 周期脉冲，启动编码 |
| `data_in[23:0]` | 输入 | 24 位原始数据 |
| `done` | 输出 | 1 周期脉冲，编码完成 |
| `codeword[63:0]` | 输出 | 64 位编码后码字 |

### 时序要求
`done` 必须在 `start` 被采样后**恰好第 2 个时钟周期**拉高。

### 编码流程
1. 对 `data_in[23:0]` 计算 CRC-16，得到 16 位 CRC。
2. 构造 64 位向量 `u[63:0]`：
   - 冻结位位置全部置 0：`u[FROZEN_POS[k]] = 0`
   - 数据位放入前 24 个信息位位置
   - CRC 位放入后 16 个信息位位置
3. 执行 Polar 蝶形变换（无比特反转）：
```
v = u
for s = 0..5:
    step = 2^(s+1)
    half = 2^s
    for i = 0..63, 步长 step:
        for j = 0..half-1:
            v[i+j] = v[i+j] XOR v[i+j+half]
codeword = v
```

### 解释
编码器是发射端的核心。它将 24 位数据扩展为 64 位码字，增加了冗余以对抗信道噪声。蝶形变换是 Polar 码的标准编码操作，本质上是递归的异或运算，可以用组合逻辑在硬件中高效实现。

---

## 任务四：实现 Polar 解码器

### 模块名
`polar64_crc16_decoder`

### 接口
| 信号 | 方向 | 说明 |
|---|---|---|
| `clk` | 输入 | 时钟 |
| `rst_n` | 输入 | 低电平复位 |
| `start` | 输入 | 1 周期脉冲，启动解码 |
| `rx[63:0]` | 输入 | 64 位接收码字（可能有比特翻转） |
| `done` | 输出 | 1 周期脉冲，解码完成 |
| `data_out[23:0]` | 输出 | 解码后的 24 位数据 |
| `valid` | 输出 | 1 = 数据有效，0 = 数据无效/不可信 |

### 时序要求
`done` 必须在 `start` 后 **12 个时钟周期内**拉高。（若 <= 8 周期可获 +5 加分）

### 解码流程
1. 对 `rx[63:0]` 执行**有界距离解码**（bounded-distance decoding，半径 = 3）：
   - 若存在唯一一个合法 Polar 码字与 `rx` 的汉明距离 <= 3，则输出该码字对应的数据，`valid=1`。
   - 否则 `valid=0`。
2. 强制冻结位为 0：`u_hat[FROZEN_POS[k]] = 0`
3. 提取数据位：`data_out[23-k] = u_hat[INFO_POS[k]]`（k=0..23）
4. 提取 CRC 位：`crc_rx[15-k] = u_hat[INFO_POS[24+k]]`（k=0..15）
5. 对 `data_out` 重新计算 CRC，与 `crc_rx` 比较：
   - 不匹配则 `valid = 0`

### 安全规则
- `valid=1` 时，`data_out` **必须**与原始发送数据一致。
- 有任何不确定，优先输出 `valid=0`。

### 解释
解码器是接收端的核心，也是本项目最复杂的部分。有界距离解码的基本思路是：对接收到的 64 位做逆 Polar 变换，检查冻结位是否为 0。如果冻结位的违反（syndrome）对应的错误模式在 3 位以内，就进行纠正；否则认为不可纠正，拒绝输出。CRC 校验作为第二道防线进一步确保安全。

---

## 任务五：编写/扩展验证测试平台

### 要求
使用提供的 `tb_basic.sv`，至少包含以下测试：

| 测试场景 | 预期行为 |
|---|---|
| **Case A：0 位翻转** | `valid=1`，`data_out` 正确 |
| **Case B：1~3 位翻转** | 解码器纠正错误，`valid=1`，`data_out` 正确 |
| **Case C：4 位翻转** | 解码器检测到不可纠正，`valid=0` |

### 仿真命令（Vivado xsim）
```bash
xvlog -sv polar_common_pkg.sv polar64_crc16_encoder.sv \
    polar64_crc16_decoder.sv tb_basic.sv
xelab tb_basic -debug typical -s sim_snapshot
xsim sim_snapshot -runall
```

### 解释
验证是确保设计正确的关键步骤。需要覆盖无错、少量错误（可纠正）、较多错误（应拒绝）等场景。波形检查可以帮助调试时序问题。

---

## 任务六：撰写文档与提交

### 提交文件结构
```
team_<XX>_submission.zip
├── polar64_crc16_encoder.sv   # Polar 编码器
├── polar64_crc16_decoder.sv   # Polar 解码器
├── crc.sv                     # CRC 模块（可选，如已集成到编码器/解码器中）
├── tb_basic.sv                # 测试平台（如有扩展）
├── README.md                  # 说明文档
├── report.pdf                 # 报告（最多 2 页）
└── ai_log.txt                 # AI 使用日志（必须提交）
```

### README.md 需包含
- 完整的 Vivado xsim 编译运行命令
- 各模块描述和延迟行为
- 分工说明（谁做了什么）

### report.pdf（最多 2 页）需包含
- 编码器/解码器架构总结
- CRC 集成描述
- 验证策略和关键测试
- 一段关于系统鲁棒性/安全行为的简短反思

### ai_log.txt 需包含
- 使用的 AI 提示词
- 采纳了哪些生成代码
- 做了哪些修改及原因

---

## 评分标准总览

| 评分项 | 分值 |
|---|---|
| CRC 实现与集成正确性 | 15 |
| Polar 编码器正确性（符合规范） | 20 |
| 解码器在无错信道上的正确性 | 15 |
| 安全行为（不输出错误的 valid=1） | 20 |
| 接口/时序要求 | 10 |
| 测试平台质量 + xsim 可复现性 | 10 |
| 代码质量 + 文档 | 10 |
| **总计** | **100** |

### 加分项

| 加分项 | 分值 |
|---|---|
| 解码器 `done` <= 8 周期 | +5 |
| 流水线/高吞吐架构 | +5 |
| 清晰的可综合 RTL 风格 | +5 |

---

## 任务依赖关系

```
任务一（位置映射）
    |
    v
任务二（CRC 模块）──> 任务三（编码器）──> 任务四（解码器）──> 任务五（验证）──> 任务六（文档提交）
```

**建议优先级：** 先确定位置映射和 CRC 模块，再并行开发编码器和解码器，最后集成验证并撰写文档。

---

## 关键注意事项

1. **比特顺序**：CRC 是 MSB 优先处理，数据位和 CRC 位在 `u` 向量中的映射顺序要严格按规范。
2. **冻结位必须为 0**：编码时置 0，解码时强制为 0。
3. **安全优先**：宁可 `valid=0` 拒绝，也不能让错误数据通过（`valid=1` 但数据错误会严重扣分，占 20 分）。
4. **时序必须满足**：编码器 2 周期完成，解码器 12 周期内完成。
5. **每队只有 2 次提交机会**，提交前务必充分验证。
6. **前 3 名完成的队伍有额外加分奖励。**
